<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DCA Adventure Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg: #050816;
      --card: #111827;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2933;
      --success: #22c55e;
      --danger: #ef4444;
      --warn: #eab308;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 12px;
    }

    .app-shell {
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9));
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow:
        0 20px 60px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.9);
      overflow: visible;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 60%);
    }

    .title-block h1 {
      font-size: 1.1rem;
      margin: 0;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .title-block p {
      margin: 2px 0 0;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    button {
      border-radius: 999px;
      border: 1px solid rgba(249,115,22,0.6);
      background: radial-gradient(circle at top, #f97316 0, #ea580c 40%, #9a3412 100%);
      color: #0b1120;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 7px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.9), 0 12px 30px rgba(249,115,22,0.35);
      white-space: nowrap;
    }

    button span.icon {
      font-size: 1rem;
    }

    button.secondary {
      background: rgba(15,23,42,0.8);
      border-color: rgba(148,163,184,0.5);
      color: #e5e7eb;
      box-shadow: none;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    main {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .sidebar {
      width: 260px;
      border-right: 1px solid rgba(55,65,81,0.7);
      padding: 12px 14px 14px;
      background: radial-gradient(circle at top, #020617 0, #020617 100%);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .content {
      flex: 1;
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.72rem;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--muted);
      background: rgba(15,23,42,0.8);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.18);
    }

    .stat-card {
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9) 0, rgba(15,23,42,0.98) 40%, #020617 100%);
      border: 1px solid rgba(55,65,81,0.85);
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .stat-main {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
    }

    .stat-main strong {
      font-size: 1.2rem;
      letter-spacing: 0.03em;
    }

    .stat-sub {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .progress-bar {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-bar-inner {
      position: absolute;
      inset: 0;
      transform-origin: left center;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      box-shadow: 0 0 10px rgba(34,197,94,0.8);
      transform: scaleX(0);
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .land-filter {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 0.72rem;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--muted);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
    }

    .chip.active {
      border-color: rgba(249,115,22,0.9);
      background: rgba(249,115,22,0.15);
      color: #fed7aa;
    }

    .legend {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 0.65rem;
      color: var(--muted);
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
    }

    .dot.green { background: var(--success); }
    .dot.yellow { background: var(--warn); }
    .dot.red { background: var(--danger); }
    .dot.gray { background: #6b7280; }

    .lands {
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow-y: visible;
      padding-right: 4px;
    }

    .land-section {
      border-radius: 14px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.94) 0, #020617 70%);
      border: 1px solid rgba(55,65,81,0.85);
      padding: 10px 11px 11px;
    }

    .land-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .land-name {
      font-size: 0.85rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .land-meta {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .rides-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    .ride-card {
      border-radius: 12px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(55,65,81,0.85);
      padding: 7px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      transition: transform 0.08s ease, border-color 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
    }

    .ride-card:hover {
      transform: translateY(-1px);
      border-color: rgba(249,115,22,0.6);
      box-shadow: 0 10px 20px rgba(15,23,42,0.8);
    }

    .ride-card.done {
      border-color: rgba(34,197,94,0.9);
      background: radial-gradient(circle at top left, rgba(22,101,52,0.25) 0, rgba(15,23,42,0.98) 55%, #020617 100%);
      opacity: 0.9;
    }

    .ride-top {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .ride-name {
      font-size: 0.8rem;
      font-weight: 500;
    }

    .ride-badges {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .ride-tag {
      font-size: 0.65rem;
      border-radius: 999px;
      padding: 2px 6px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--muted);
    }

    .ride-tag.headliner {
      border-color: rgba(249,115,22,0.9);
      color: #fed7aa;
    }

    .ride-tag.completed {
      border-color: rgba(34,197,94,0.9);
      color: #bbf7d0;
    }

    .ride-bottom {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
      margin-top: 2px;
    }

    .wait-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--muted);
    }

    .wait-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
    }

    .ride-note {
      font-size: 0.68rem;
      color: var(--muted);
    }

    .checkbox {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: #22c55e;
      flex-shrink: 0;
    }

    .checkbox.checked {
      border-color: rgba(34,197,94,0.9);
      background: rgba(22,163,74,0.2);
    }

    .sidebar-section-title {
      font-size: 0.75rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .sidebar-section {
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.85);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95) 0, #020617 80%);
      padding: 7px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-rides {
      max-height: 230px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .sidebar-ride-row {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 4px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.74rem;
      color: var(--muted);
    }

    .sidebar-ride-row:hover {
      background: rgba(15,23,42,0.85);
    }

    .sidebar-ride-row.done {
      color: #bbf7d0;
    }

    .sidebar-ride-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar-wait {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .map-panel {
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.85);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95) 0, #020617 80%);
      padding: 8px 10px 10px;
      margin-top: 2px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .map-title {
      font-size: 0.78rem;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .map-body {
      border-radius: 10px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96) 0, #020617 85%);
      border: 1px solid rgba(31,41,55,0.9);
      padding: 8px;
      font-size: 0.7rem;
      color: var(--muted);
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 8px;
    }

    .mini-map {
      border-radius: 10px;
      border: 1px dashed rgba(75,85,99,0.9);
      background:
        radial-gradient(circle at 20% 20%, rgba(248,250,252,0.04) 0, transparent 40%),
        radial-gradient(circle at 80% 30%, rgba(96,165,250,0.05) 0, transparent 45%),
        radial-gradient(circle at 40% 80%, rgba(45,212,191,0.06) 0, transparent 50%),
        #020617;
      padding: 6px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      grid-auto-rows: 60px;
      gap: 4px;
    }

    .map-land {
      border-radius: 8px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.95);
      padding: 3px 4px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 2px;
      cursor: pointer;
    }

    .map-land-title {
      font-size: 0.65rem;
      color: #e5e7eb;
    }

    .map-land-wait {
      font-size: 0.64rem;
      color: var(--muted);
    }

    .map-land.active {
      border-color: rgba(249,115,22,0.9);
      box-shadow: 0 0 0 1px rgba(249,115,22,0.35);
    }

    .map-next {
      font-size: 0.68rem;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .map-next-item {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: baseline;
    }

    .map-next-name {
      flex: 1;
    }

    .map-next-time {
      color: #e5e7eb;
    }

    .timestamp {
      font-size: 0.67rem;
      color: var(--muted);
      text-align: right;
    }

    .error {
      font-size: 0.7rem;
      color: #fecaca;
    }

    @media (max-width: 900px) {
      .app-shell {
        border-radius: 0;
      }

      body {
        padding: 0;
      }

      main {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(55,65,81,0.7);
      }

      .map-body {
        grid-template-columns: 1fr;
      }

      .mini-map {
        grid-auto-rows: 52px;
      }
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .controls {
        justify-content: flex-start;
      }

      .rides-grid {
        grid-template-columns: minmax(0, 1fr);
      }

      .app-shell {
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="title-block">
      <h1>Disney California Adventure – Day Planner</h1>
      <p>Track must‑do attractions and watch live wait times while you tour the park.</p>
    </div>
    <div class="controls">
      <div class="pill">
        <span class="pill-dot"></span>
        Live wait times
      </div>
      <button class="secondary" id="resetBtn" type="button">
        <span class="icon">↺</span>
        Reset checklist
      </button>
      <button id="refreshBtn" type="button">
        <span class="icon">⟳</span>
        Refresh wait times
      </button>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div class="stat-card">
        <div class="stat-label">Today’s progress</div>
        <div class="stat-main">
          <strong id="progressText">0 / 0</strong>
          <span class="stat-sub" id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
          <div id="progressBar" class="progress-bar-inner"></div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-section-title">Checklist</div>
        <div class="sidebar-rides" id="sidebarRides"></div>
      </div>

      <div class="map-panel">
        <div class="map-header">
          <div class="map-title">Park map overview</div>
          <span class="stat-sub">Tap a land to filter</span>
        </div>
        <div class="map-body">
          <div class="mini-map" id="miniMap"></div>
          <div class="map-next" id="nextSuggestions">
            <div><strong>Suggested next rides</strong></div>
            <div class="map-next-item">
              <span class="map-next-name">Waiting for data…</span>
            </div>
          </div>
        </div>
        <div class="timestamp" id="timestamp">No wait data yet.</div>
        <div class="error" id="errorMessage"></div>
      </div>
    </aside>

    <section class="content">
      <div class="filter-row">
        <div class="land-filter" id="landFilter"></div>
        <div class="legend">
          <span>Wait time:</span>
          <span class="legend-item"><span class="dot green"></span> 0–30</span>
          <span class="legend-item"><span class="dot yellow"></span> 31–60</span>
          <span class="legend-item"><span class="dot red"></span> 61+</span>
          <span class="legend-item"><span class="dot gray"></span> Closed</span>
        </div>
      </div>
      <div class="lands" id="landsContainer"></div>
    </section>
  </main>
</div>

<script>
  const LOCAL_STORAGE_KEY = "dcaPlannerCompletedV1";

  // DCA is park 17 on Queue Times. [web:3][web:154]
  const QUEUE_TIMES_PARK_ID = 17;

  const ATTRACTIONS = [
    { id: "guardians", name: "Guardians of the Galaxy – Mission: Breakout!", land: "Avengers Campus", headliner: true, priority: 1, notes: "Intense drop tower; great to hit early or late." },
    { id: "webslingers", name: "WEB SLINGERS: A Spider-Man Adventure", land: "Avengers Campus", headliner: true, priority: 2, notes: "Interactive shooter; can build long lines." },
    { id: "rsr", name: "Radiator Springs Racers", land: "Cars Land", headliner: true, priority: 0, notes: "Top priority; best early morning, single rider, or late night." },
    { id: "maters", name: "Mater’s Junkyard Jamboree", land: "Cars Land", headliner: false, priority: 7, notes: "Good family ride; flexible timing." },
    { id: "luigis", name: "Luigi’s Rollickin’ Roadsters", land: "Cars Land", headliner: false, priority: 8, notes: "Short ride; nice if nearby." },
    { id: "incredicoaster", name: "Incredicoaster", land: "Pixar Pier", headliner: true, priority: 3, notes: "Major coaster; can be cooler at night." },
    { id: "tsmm", name: "Toy Story Midway Mania!", land: "Pixar Pier", headliner: true, priority: 4, notes: "Fun shooter; queue is mostly indoors." },
    { id: "pixarpal", name: "Pixar Pal-A-Round (Non-Swinging)", land: "Pixar Pier", headliner: false, priority: 10, notes: "Great views if you like heights." },
    { id: "insideout", name: "Inside Out Emotional Whirlwind", land: "Pixar Pier", headliner: false, priority: 12, notes: "Nice filler ride if wait is short." },
    { id: "mermaid", name: "The Little Mermaid ~ Ariel’s Undersea Adventure", land: "Paradise Gardens Park", headliner: false, priority: 6, notes: "Usually moderate waits; air-conditioned." },
    { id: "goofys", name: "Goofy’s Sky School", land: "Paradise Gardens Park", headliner: false, priority: 5, notes: "Can be a bit rough; good if line is short." },
    { id: "sillysymphony", name: "Silly Symphony Swings", land: "Paradise Gardens Park", headliner: false, priority: 11, notes: "Weather sensitive; can close for wind." },
    { id: "grizzly", name: "Grizzly River Run", land: "Grizzly Peak", headliner: true, priority: 9, notes: "You will get wet; better when it’s warm." },
    { id: "soarin", name: "Soarin’ Around the World", land: "Grizzly Peak", headliner: true, priority: 2, notes: "Classic with great capacity; aim earlier in the day." },
    { id: "monsters", name: "Monsters, Inc. Mike & Sulley to the Rescue!", land: "Hollywood Land", headliner: false, priority: 6, notes: "Good family dark ride; can spike later." },
    { id: "redcar", name: "Red Car Trolley", land: "Buena Vista Street", headliner: false, priority: 13, notes: "More of an atmosphere/transport attraction." }
  ];

  let completed = new Set();
  let currentLandFilter = "All";
  let latestWaits = null;

  function loadCompletedFromStorage() {
    try {
      const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (stored) {
        const arr = JSON.parse(stored);
        if (Array.isArray(arr)) completed = new Set(arr);
      }
    } catch (e) {
      console.warn("Failed to read local storage", e);
    }
  }

  function saveCompletedToStorage() {
    try {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(Array.from(completed)));
    } catch (e) {
      console.warn("Failed to write local storage", e);
    }
  }

  function getAttractionsByLand() {
    const groups = {};
    for (const a of ATTRACTIONS) {
      if (!groups[a.land]) groups[a.land] = [];
      groups[a.land].push(a);
    }
    for (const land of Object.keys(groups)) {
      groups[land].sort((a, b) => a.priority - b.priority);
    }
    return groups;
  }

  function getWaitColor(wait) {
    if (wait === null || wait === undefined) return "gray";
    if (wait <= 30) return "green";
    if (wait <= 60) return "yellow";
    return "red";
  }

  function resolveWaitForAttraction(attr, waits) {
    if (!waits) return null;
    const nameNorm = attr.name.toLowerCase();
    let best = null;

    for (const land of waits.lands || []) {
      for (const ride of land.rides || []) {
        const rideName = (ride.name || "").toLowerCase();
        if (rideName === nameNorm) {
          best = ride;
          break;
        }
      }
      if (best) break;
    }

    if (!best) {
      for (const land of waits.lands || []) {
        for (const ride of land.rides || []) {
          const rideName = (ride.name || "").toLowerCase();
          if (rideName.includes(nameNorm) || nameNorm.includes(rideName)) {
            best = ride;
            break;
          }
        }
        if (best) break;
      }
    }

    if (!best) return null;
    if (best.is_open === false) return { wait: null, status: "closed" };
    if (best.wait_time === 0 && best.is_open === true) return { wait: 0, status: "open" };
    return { wait: best.wait_time ?? null, status: best.is_open ? "open" : "closed" };
  }

  function computeLandSummary(landName) {
    const byLand = getAttractionsByLand();
    const rides = byLand[landName] || [];
    if (!rides.length) return { avgWait: null, done: 0, total: 0 };
    let sum = 0, count = 0, done = 0;
    for (const r of rides) {
      const w = resolveWaitForAttraction(r, latestWaits);
      if (w && w.wait !== null) {
        sum += w.wait;
        count++;
      }
      if (completed.has(r.id)) done++;
    }
    return {
      avgWait: count ? Math.round(sum / count) : null,
      done,
      total: rides.length
    };
  }

  function updateProgress() {
    const total = ATTRACTIONS.length;
    const done = completed.size;
    const pct = total ? Math.round((done / total) * 100) : 0;
    document.getElementById("progressText").textContent = `${done} / ${total}`;
    document.getElementById("progressPercent").textContent = `${pct}%`;
    const bar = document.getElementById("progressBar");
    bar.style.transform = `scaleX(${pct / 100})`;
  }

  function renderFilters() {
    const lands = Object.keys(getAttractionsByLand()).sort();
    const landFilter = document.getElementById("landFilter");
    landFilter.innerHTML = "";
    const allChip = document.createElement("button");
    allChip.type = "button";
    allChip.className = "chip" + (currentLandFilter === "All" ? " active" : "");
    allChip.textContent = "All lands";
    allChip.addEventListener("click", () => {
      currentLandFilter = "All";
      renderFilters();
      renderLands();
    });
    landFilter.appendChild(allChip);
    for (const land of lands) {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "chip" + (currentLandFilter === land ? " active" : "");
      chip.textContent = land;
      chip.addEventListener("click", () => {
        currentLandFilter = land;
        renderFilters();
        renderLands();
        highlightMapLand(land);
      });
      landFilter.appendChild(chip);
    }
  }

  function renderSidebar() {
    const container = document.getElementById("sidebarRides");
    container.innerHTML = "";
    const sorted = [...ATTRACTIONS].sort((a, b) => a.priority - b.priority);
    for (const a of sorted) {
      const row = document.createElement("div");
      row.className = "sidebar-ride-row" + (completed.has(a.id) ? " done" : "");
      row.dataset.id = a.id;

      const cb = document.createElement("div");
      cb.className = "checkbox" + (completed.has(a.id) ? " checked" : "");
      cb.textContent = completed.has(a.id) ? "✓" : "";

      const name = document.createElement("div");
      name.className = "sidebar-ride-name";
      name.textContent = a.name;

      const waitSpan = document.createElement("div");
      waitSpan.className = "sidebar-wait";
      const waitInfo = resolveWaitForAttraction(a, latestWaits);
      if (!waitInfo) {
        waitSpan.textContent = "–";
      } else if (waitInfo.status === "closed") {
        waitSpan.textContent = "Closed";
      } else if (waitInfo.wait === 0) {
        waitSpan.textContent = "No wait";
      } else {
        waitSpan.textContent = `${waitInfo.wait} min`;
      }

      row.appendChild(cb);
      row.appendChild(name);
      row.appendChild(waitSpan);

      row.addEventListener("click", () => toggleCompleted(a.id));

      container.appendChild(row);
    }
  }

  function renderLands() {
    const container = document.getElementById("landsContainer");
    container.innerHTML = "";
    const byLand = getAttractionsByLand();
    const lands = Object.keys(byLand).sort();
    for (const land of lands) {
      if (currentLandFilter !== "All" && currentLandFilter !== land) continue;
      const section = document.createElement("section");
      section.className = "land-section";
      const header = document.createElement("div");
      header.className = "land-header";
      const name = document.createElement("div");
      name.className = "land-name";
      name.textContent = land;
      const meta = document.createElement("div");
      meta.className = "land-meta";
      const summary = computeLandSummary(land);
      const waitText = summary.avgWait === null ? "Avg wait: –" : `Avg wait: ${summary.avgWait} min`;
      meta.textContent = `${waitText} · ${summary.done}/${summary.total} done`;
      header.appendChild(name);
      header.appendChild(meta);

      const grid = document.createElement("div");
      grid.className = "rides-grid";
      for (const a of byLand[land]) {
        const card = document.createElement("article");
        card.className = "ride-card" + (completed.has(a.id) ? " done" : "");
        card.dataset.id = a.id;

        const top = document.createElement("div");
        top.className = "ride-top";

        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.alignItems = "center";
        left.style.gap = "6px";

        const cb = document.createElement("div");
        cb.className = "checkbox" + (completed.has(a.id) ? " checked" : "");
        cb.textContent = completed.has(a.id) ? "✓" : "";

        const title = document.createElement("div");
        title.className = "ride-name";
        title.textContent = a.name;

        left.appendChild(cb);
        left.appendChild(title);

        const badges = document.createElement("div");
        badges.className = "ride-badges";
        if (a.headliner) {
          const b = document.createElement("span");
          b.className = "ride-tag headliner";
          b.textContent = "Headliner";
          badges.appendChild(b);
        }
        if (completed.has(a.id)) {
          const c = document.createElement("span");
          c.className = "ride-tag completed";
          c.textContent = "Done";
          badges.appendChild(c);
        }

        top.appendChild(left);
        top.appendChild(badges);

        const bottom = document.createElement("div");
        bottom.className = "ride-bottom";

        const waitPill = document.createElement("div");
        waitPill.className = "wait-pill";
        const waitInfo = resolveWaitForAttraction(a, latestWaits);
        const dot = document.createElement("span");
        dot.className = "wait-dot " + getWaitColor(waitInfo ? waitInfo.wait : null);
        const label = document.createElement("span");

        if (!waitInfo) {
          label.textContent = "Wait: –";
        } else if (waitInfo.status === "closed") {
          label.textContent = "Closed";
        } else if (waitInfo.wait === 0) {
          label.textContent = "No wait";
        } else {
          label.textContent = `${waitInfo.wait} min`;
        }

        waitPill.appendChild(dot);
        waitPill.appendChild(label);

        const note = document.createElement("div");
        note.className = "ride-note";
        note.textContent = a.notes || "";

        bottom.appendChild(waitPill);
        bottom.appendChild(note);

        card.appendChild(top);
        card.appendChild(bottom);

        card.addEventListener("click", () => toggleCompleted(a.id));

        grid.appendChild(card);
      }

      section.appendChild(header);
      section.appendChild(grid);
      container.appendChild(section);
    }
  }

  function renderMiniMap() {
    const mini = document.getElementById("miniMap");
    mini.innerHTML = "";
    const lands = Object.keys(getAttractionsByLand()).sort();
    for (const land of lands) {
      const box = document.createElement("div");
      box.className = "map-land";
      box.dataset.land = land;

      const title = document.createElement("div");
      title.className = "map-land-title";
      title.textContent = land;

      const summary = computeLandSummary(land);
      const waitText = summary.avgWait === null ? "Avg: –" : `Avg: ${summary.avgWait}m`;
      const landWait = document.createElement("div");
      landWait.className = "map-land-wait";
      landWait.textContent = `${waitText} • ${summary.done}/${summary.total} done`;

      box.appendChild(title);
      box.appendChild(landWait);

      box.addEventListener("click", () => {
        currentLandFilter = land;
        renderFilters();
        renderLands();
        highlightMapLand(land);
      });

      mini.appendChild(box);
    }
    highlightMapLand(currentLandFilter);
  }

  function highlightMapLand(landName) {
    const nodes = document.querySelectorAll(".map-land");
    nodes.forEach(n => {
      if (n.dataset.land === landName) {
        n.classList.add("active");
      } else {
        n.classList.remove("active");
      }
    });
  }

  function renderNextSuggestions() {
    const container = document.getElementById("nextSuggestions");
    container.innerHTML = "";
    const title = document.createElement("div");
    title.innerHTML = "<strong>Suggested next rides</strong>";
    container.appendChild(title);

    const candidates = ATTRACTIONS
      .filter(a => !completed.has(a.id))
      .slice()
      .sort((a, b) => a.priority - b.priority);

    const scored = [];
    for (const a of candidates) {
      const w = resolveWaitForAttraction(a, latestWaits);
      let wait = w && w.status !== "closed" ? (w.wait ?? 999) : 999;
      scored.push({ a, wait });
    }
    scored.sort((x, y) => {
      if (x.wait === y.wait) return x.a.priority - y.a.priority;
      return x.wait - y.wait;
    });

    const top = scored.slice(0, 4);
    if (!top.length) {
      const row = document.createElement("div");
      row.className = "map-next-item";
      row.textContent = "All done! Time for photos and snacks.";
      container.appendChild(row);
      return;
    }

    for (const item of top) {
      const row = document.createElement("div");
      row.className = "map-next-item";
      const name = document.createElement("div");
      name.className = "map-next-name";
      name.textContent = `${item.a.name} (${item.a.land})`;
      const time = document.createElement("div");
      time.className = "map-next-time";
      if (item.wait >= 999) {
        time.textContent = "Unknown/closed";
      } else if (item.wait === 0) {
        time.textContent = "No wait";
      } else {
        time.textContent = `${item.wait} min`;
      }
      row.appendChild(name);
      row.appendChild(time);
      row.addEventListener("click", () => {
        currentLandFilter = item.a.land;
        renderFilters();
        renderLands();
        highlightMapLand(item.a.land);
      });
      container.appendChild(row);
    }
  }

  function toggleCompleted(id) {
    if (completed.has(id)) {
      completed.delete(id);
    } else {
      completed.add(id);
    }
    saveCompletedToStorage();
    updateProgress();
    renderSidebar();
    renderLands();
    renderMiniMap();
    renderNextSuggestions();
  }

  async function fetchWaitTimes() {
    const refreshBtn = document.getElementById("refreshBtn");
    const ts = document.getElementById("timestamp");
    const err = document.getElementById("errorMessage");
    err.textContent = "";
    refreshBtn.disabled = true;
    refreshBtn.textContent = "Refreshing…";

    try {
      const url = `https://queue-times.com/parks/${QUEUE_TIMES_PARK_ID}/queue_times.json`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      latestWaits = data;

      const now = new Date();
      ts.textContent = `Updated ${now.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" })}`;
      renderSidebar();
      renderLands();
      renderMiniMap();
      renderNextSuggestions();
    } catch (e) {
      console.error(e);
      err.textContent = "Could not load live wait times. You can still use the checklist.";
    } finally {
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = '<span class="icon">⟳</span>Refresh wait times';
    }
  }

  function resetChecklist() {
    if (!confirm("Reset all completed rides for today?")) return;
    completed.clear();
    saveCompletedToStorage();
    updateProgress();
    renderSidebar();
    renderLands();
    renderMiniMap();
    renderNextSuggestions();
  }

  function init() {
    loadCompletedFromStorage();
    updateProgress();
    renderFilters();
    renderSidebar();
    renderLands();
    renderMiniMap();
    renderNextSuggestions();

    document.getElementById("refreshBtn").addEventListener("click", fetchWaitTimes);
    document.getElementById("resetBtn").addEventListener("click", resetChecklist);

    setTimeout(fetchWaitTimes, 800);
    setInterval(fetchWaitTimes, 5 * 60 * 1000);
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
